<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Make It Easy - YouTube to PDF</title>
    <link rel="stylesheet" href="/static/style.css?v=1.7">
</head>
<body>
    <div class="container">
        <!-- Authentication Section -->
        <div id="auth-section" class="auth-section">
            <div class="header">
                <img src="static/images/logo.png" alt="Make It Easy logo">
                <p>Transform how-to videos into step-by-step recipes</p>
            </div>
            
            <!-- Login/Register Tabs -->
            <div class="auth-card">
                <div class="auth-tabs">
                    <button class="auth-tab-btn active" data-tab="login">Sign In</button>
                    <button class="auth-tab-btn" data-tab="register">Register</button>
                </div>
                
                <!-- Login Form -->
                <div id="login-tab" class="auth-tab-content active">
                    <form id="login-form">
                        <div class="input-group">
                            <label for="login-email">Email:</label>
                            <input type="email" id="login-email" required>
                        </div>
                        <div class="input-group">
                            <label for="login-password">Password:</label>
                            <input type="password" id="login-password" required>
                        </div>
                        <button type="submit" class="btn auth-btn">Sign In</button>
                    </form>
                    
                    <div class="auth-divider">
                        <span>or</span>
                    </div>
                    
                    <div id="google-signin-btn" class="google-signin-btn">
                        <svg class="google-icon" viewBox="0 0 24 24">
                            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        Continue with Google
                    </div>
                </div>
                
                <!-- Register Form -->
                <div id="register-tab" class="auth-tab-content">
                    <form id="register-form">
                        <div class="input-group">
                            <label for="register-name">Full Name:</label>
                            <input type="text" id="register-name" required>
                        </div>
                        <div class="input-group">
                            <label for="register-email">Email:</label>
                            <input type="email" id="register-email" required>
                        </div>
                        <div class="input-group">
                            <label for="register-password">Password:</label>
                            <input type="password" id="register-password" minlength="6" required>
                        </div>
                        <button type="submit" class="btn auth-btn">Register</button>
                    </form>
                    
                    <div class="auth-divider">
                        <span>or</span>
                    </div>
                    
                    <div id="google-signup-btn" class="google-signin-btn">
                        <svg class="google-icon" viewBox="0 0 24 24">
                            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        Sign up with Google
                    </div>
                </div>
            </div>
        </div>

        <!-- Main App Section (Hidden until logged in) -->
        <div id="app-section" class="app-section" style="display: none;">
        <div class="header">
                <img src="static/images/logo.png" alt="Make It Easy logo">
                <p>Transform how-to videos into step-by-step recipes</p>
                <div class="header-controls">
                    <!-- Guest controls (shown when not logged in) -->
                    <div id="guest-controls" style="display: none;">
                        <button id="signin-btn" class="btn signin-btn" onclick="showAuthSection()">
                            <svg class="heroicon" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
                            </svg>
                            Sign In
                        </button>
                        <button id="create-account-btn" class="btn create-account-btn" onclick="showCreateAccountForm()">
                            <svg class="heroicon" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M18 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0ZM3 19.235v-.11a6.375 6.375 0 0 1 12.75 0v.109A12.318 12.318 0 0 1 9.374 21c-2.331 0-4.512-.645-6.374-1.766Z" />
                            </svg>
                            Create Account
                        </button>
                    </div>
                    
                    <!-- Logged in controls (shown when logged in) -->
                    <div id="logged-in-controls" style="display: none;">
                        <button id="reset-btn" class="btn reset-btn" onclick="resetCounter()" title="Reset PDF counter">
                            <svg class="heroicon" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
                            </svg>
                            Reset
                        </button>
                        <div class="user-info">
                            <span id="welcome-message">Welcome!</span>
                            <button id="logout-btn" class="btn logout-btn">Sign Out</button>
                        </div>
                    </div>
                </div>
        </div>
        
        <div class="card">
            <!-- Tabs -->
            <div class="tabs">
                <div class="tab-buttons">
                    <button class="tab-btn active" data-tab="paste">üìé Paste Link</button>
                    <button class="tab-btn" data-tab="search">üîç Search YouTube</button>
                </div>
            </div>

            <!-- Paste Tab Content -->
            <div id="paste-tab" class="tab-content active">
                <div class="input-group">
                    <label for="youtube-url">YouTube URL:</label>
                    <input 
                        type="url" 
                        id="youtube-url" 
                        placeholder="Paste YouTube link here... (e.g. https://www.youtube.com/watch?v=...)"
                        required
                    >
                </div>
            </div>

            <!-- Search Tab Content -->
            <div id="search-tab" class="tab-content">
                <div class="search-section">
                    <label for="youtube-search">YouTube search:</label>
                    <div class="search-input-group">
                        <input 
                            type="text" 
                            id="youtube-search" 
                            placeholder="recipe"
                            value="recipe"
                        >
                        <button id="search-btn" class="btn search-btn">Search</button>
                    </div>
                </div>

                <div id="search-results" class="search-results">
                    <div class="search-placeholder">
                        <p>
                            üîç Search for cooking videos above to see results here
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="input-group">
                <label for="language-select">Language:</label>
                <select id="language-select" class="language-select">
                    <option value="en" selected>üá∫üá∏ English</option>
                    <option value="sv">üá∏üá™ Svenska</option>
                    <option value="no">üá≥üá¥ Norsk</option>
                    <option value="da">üá©üá∞ Dansk</option>
                    <option value="de">üá©üá™ Deutsch</option>
                    <option value="fr">üá´üá∑ Fran√ßais</option>
                    <option value="es">üá™üá∏ Espa√±ol</option>
                    <option value="it">üáÆüáπ Italiano</option>
                    <option value="pt">üáµüáπ Portugu√™s</option>
                    <option value="nl">üá≥üá± Nederlands</option>
                    <option value="pl">üáµüá± Polski</option>
                    <option value="ru">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
                    <option value="zh">üá®üá≥ ‰∏≠Êñá</option>
                    <option value="ja">üáØüáµ Êó•Êú¨Ë™û</option>
                    <option value="ko">üá∞üá∑ ÌïúÍµ≠Ïñ¥</option>
                </select>
            </div>
            <button id="process-btn" class="btn" onclick="processVideo()">
                <svg class="heroicon" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.59 14.37a6 6 0 0 1-5.84 7.38v-4.8m5.84-2.58a14.98 14.98 0 0 0 6.16-12.12A14.98 14.98 0 0 0 9.631 8.41m5.96 5.96a14.926 14.926 0 0 1-5.841 2.58m-.119-8.54a6 6 0 0 0-7.381 5.84h4.8m2.581-5.84a14.927 14.927 0 0 0-2.58 5.84m2.58-5.84a14.917 14.917 0 0 1 5.84 2.58" />
                </svg>
                Create PDF Instructions
            </button>
            <!-- Main progress status bar -->
            <div id="main-status-box">
                <span id="main-status-text">Status</span>
                <div id="main-status-progress-fill"></div>
            </div>
        </div>
        
        <div class="footer">
                <p>@ 2025 Food2Guide</p>
            </div>
        </div>
    </div>

    <!-- Guest Welcome Modal -->
    <div id="guest-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <img src="static/logo.png" alt="Food2Guide" class="modal-logo">
                    <h2>Welcome to Food2Guide!</h2>
                </div>
                <span class="close" onclick="closeGuestModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p>Transform any YouTube cooking video into a beautiful PDF recipe guide!</p>
                
                <div class="option-cards">
                    <div class="option-card guest-option">
                        <div class="option-icon">
                            <svg class="heroicon heroicon-lg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
                            </svg>
                        </div>
                        <h3>Try as Guest</h3>
                        <ul>
                            <li>
                                <svg class="heroicon" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" />
                                </svg>
                                Create 2 PDFs per day
                            </li>
                            <li>
                                <svg class="heroicon" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" />
                                </svg>
                                No registration required
                            </li>
                            <li class="negative">
                                <svg class="heroicon" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                                </svg>
                                No PDF history
                            </li>
                        </ul>
                        <button id="continue-guest-btn" class="btn guest-btn">Continue as Guest</button>
                    </div>
                    
                    <div class="option-card premium-option">
                        <div class="option-icon">
                            <svg class="heroicon heroicon-lg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456Z" />
                            </svg>
                        </div>
                        <h3>Create Free Account</h3>
                        <ul>
                            <li>
                                <svg class="heroicon" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" />
                                </svg>
                                Unlimited PDFs
                            </li>
                            <li>
                                <svg class="heroicon" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" />
                                </svg>
                                Save PDF history
                            </li>
                            <li>
                                <svg class="heroicon" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" />
                                </svg>
                                Access anywhere
                            </li>
                        </ul>
                        <button id="signup-btn" class="btn premium-btn">Sign Up Free</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentJobId = null;
        let currentSessionId = null;
        let statusInterval = null;
        let isGloballyProcessing = false;
        let selectedVideoId = null;
        
        const API_BASE = 'http://localhost:8000';
        
        // Heroicons helper function
        function getHeroIcon(iconName, extraClasses = '') {
            const icons = {
                'rocket': `<svg class="heroicon ${extraClasses}" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.59 14.37a6 6 0 0 1-5.84 7.38v-4.8m5.84-2.58a14.98 14.98 0 0 0 6.16-12.12A14.98 14.98 0 0 0 9.631 8.41m5.96 5.96a14.926 14.926 0 0 1-5.841 2.58m-.119-8.54a6 6 0 0 0-7.381 5.84h4.8m2.581-5.84a14.927 14.927 0 0 0-2.58 5.84m2.58-5.84a14.917 14.917 0 0 1 5.84 2.58" />
                </svg>`,
                'spinner': `<svg class="heroicon heroicon-spin ${extraClasses}" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
                </svg>`,
                'check-circle': `<svg class="heroicon ${extraClasses}" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                </svg>`,
                'exclamation-triangle': `<svg class="heroicon ${extraClasses}" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
                </svg>`,
                'download': `<svg class="heroicon ${extraClasses}" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
                </svg>`,
                'info-circle': `<svg class="heroicon ${extraClasses}" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="m11.25 11.25.041-.02a.75.75 0 0 1 1.063.852l-.708 2.836a.75.75 0 0 0 1.063.853l.041-.021M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9-3.75h.008v.008H12V8.25Z" />
                </svg>`,
                'clock': `<svg class="heroicon ${extraClasses}" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                </svg>`,
                'check': `<svg class="heroicon ${extraClasses}" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" />
                </svg>`,
                'magnifying-glass': `<svg class="heroicon ${extraClasses}" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
                </svg>`,
                'photo': `<svg class="heroicon ${extraClasses}" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm10.5-11.25h.008v.008h-.008V8.25Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" />
                </svg>`
            };
            return icons[iconName] || '';
        }

        // --- SINGLE PROGRESS BAR LOGIK ---
        
        const stepLabels = [
            'Downloading video from YouTube',
            'Transcribing audio content', 
            'Analyzing content with AI',
            'Extracting key frames',
            'Generating PDF instructions'
        ];
        
        // Calculate overall progress based on step
        function getProgressForStep(stepIndex, stepProgress = 50) {
            const stepWeights = [20, 30, 20, 15, 15]; // Each step's percentage of total
            let totalProgress = 0;
            
            // Add completed steps
            for (let i = 0; i < stepIndex; i++) {
                totalProgress += stepWeights[i];
            }
            
            // Add current step progress
            if (stepIndex < stepWeights.length) {
                totalProgress += (stepWeights[stepIndex] * stepProgress / 100);
            }
            
            return Math.min(Math.round(totalProgress), 100);
        }
        
        function updateMainProgress(stepIndex, stepProgress = 50) {
            const totalProgress = getProgressForStep(stepIndex, stepProgress);
            const stepNum = stepIndex + 1;
            const message = `STEP ${stepNum}/5: ${stepLabels[stepIndex]}`;
            showMainStatusBox(message, totalProgress);
        }
        // Global progress tracking
        let globalProgress = 0;
        let targetProgress = 0;
        let currentStep = 0;
        
        // Update progress based on backend status
        function updateStepsBasedOnStatus(status) {
            const statusUpper = status.toUpperCase();
            
            // Don't restart if we're already processing this status
            if (statusUpper === window.lastStatus) return;
            window.lastStatus = statusUpper;
            
            // Set target progress based on status
            switch(statusUpper) {
                case 'PROCESSING':
                    currentStep = 0;
                    targetProgress = 20; // Download step target
                    // Show immediately to avoid any gray state
                    showMainStatusBox('STEP 1/5: Downloading video from YouTube', 5);
                    break;
                case 'TRANSCRIBING':
                    currentStep = 1;
                    targetProgress = 50; // Transcribe step target (20+30)
                    break;
                case 'ANALYZING':
                    currentStep = 2;
                    targetProgress = 70; // Analyze step target (50+20)
                    break;
                case 'EXTRACTING_FRAMES':
                    currentStep = 3;
                    targetProgress = 85; // Extract step target (70+15)
                    break;
                case 'GENERATING_PDF':
                    currentStep = 4;
                    targetProgress = 100; // Final step target
                    break;
                case 'COMPLETED':
                    stopContinuousProgress();
                    showMainStatusBox('COMPLETED: PDF generated successfully!', 100);
                    return;
                case 'FAILED':
                    stopContinuousProgress();
                    showMainStatusBox('FAILED: Processing failed', 0);
                    return;
            }
            
            // Start continuous progress if not already running
            if (!window.progressInterval) {
                startContinuousProgress();
            }
        }
        
        // Continuous smooth progress animation
        function startContinuousProgress() {
            // If no interval is running, start one
            if (window.progressInterval) return;
            
            window.progressInterval = setInterval(() => {
                // Move towards target progress smoothly
                if (globalProgress < targetProgress) {
                    const diff = targetProgress - globalProgress;
                    const increment = Math.max(0.1, diff * 0.02); // Slower approach as we get closer
                    globalProgress = Math.min(globalProgress + increment, targetProgress);
                } else if (globalProgress < 100 && targetProgress < 100) {
                    // Add slight movement even when waiting for next status
                    globalProgress = Math.min(globalProgress + 0.05, targetProgress + 5);
                }
                
                // Update the UI
                const stepNum = currentStep + 1;
                const message = `STEP ${stepNum}/5: ${stepLabels[currentStep]}`;
                showMainStatusBox(message, Math.round(globalProgress));
                
                // Stop if we've reached 100%
                if (globalProgress >= 100) {
                    stopContinuousProgress();
                }
            }, 50); // Update every 50ms for smooth animation
        }
        
        function stopContinuousProgress() {
            if (window.progressInterval) {
                clearInterval(window.progressInterval);
                window.progressInterval = null;
            }
        }

        // Reset progress bar
        function resetSteps() {
            stopContinuousProgress();
            globalProgress = 0;
            targetProgress = 0;
            currentStep = 0;
            hideMainStatusBox();
            window.lastStatus = null;
            console.log('Progress reset');
        }
        
        // Tab functionality
        function initializeTabs() {
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTab = button.getAttribute('data-tab');
                    
                    // Remove active class from all buttons and content
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // Add active class to clicked button and corresponding content
                    button.classList.add('active');
                    document.getElementById(targetTab + '-tab').classList.add('active');
                });
            });
        }

        // YouTube search functionality
        async function searchYouTube() {
            const query = document.getElementById('youtube-search').value.trim();
            if (!query) return;

            const searchBtn = document.getElementById('search-btn');
            const originalText = searchBtn.innerHTML;
            
            searchBtn.disabled = true;
            searchBtn.innerHTML = `${getHeroIcon('spinner')} Searching...`;

            try {
                console.log('Searching for:', query);
                const response = await fetch(`${API_BASE}/api/v1/search`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: query,
                        language: document.getElementById('language-select').value
                    })
                });

                if (!response.ok) {
                    throw new Error(`Search failed: ${response.status}`);
                }

                const data = await response.json();
                console.log('Search response:', data);
                
                if (data.videos) {
                    displaySearchResults(data.videos);
                } else {
                    console.error('No videos field in response:', data);
                    displaySearchResults([]);
                }
            } catch (error) {
                console.error('Search error:', error);
                
                // Show error message
                const resultsContainer = document.getElementById('search-results');
                resultsContainer.innerHTML = `
                    <div class="search-placeholder">
                        <p style="text-align: center; color: #e74c3c; padding: 2rem;">
                            ‚ùå Search failed: ${error.message}
                        </p>
                    </div>
                `;
            } finally {
                searchBtn.disabled = false;
                searchBtn.innerHTML = originalText;
            }
        }

        // Display search results
        function displaySearchResults(videos) {
            const resultsContainer = document.getElementById('search-results');
            resultsContainer.innerHTML = '';

            if (!videos || videos.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="search-placeholder">
                        <p style="text-align: center; color: #666; padding: 2rem;">
                            No videos found for your search. Try different keywords.
                        </p>
                    </div>
                `;
                return;
            }

            videos.forEach(video => {
                const videoElement = document.createElement('div');
                videoElement.className = 'video-item';
                videoElement.setAttribute('data-video-id', video.video_id);
                
                videoElement.innerHTML = `
                    <img src="https://i.ytimg.com/vi/${video.video_id}/mqdefault.jpg" alt="Video thumbnail" class="video-thumbnail" 
                         onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22320%22 height=%22180%22><rect width=%22100%%22 height=%22100%%22 fill=%22%23f0f0f0%22/><text x=%2250%%22 y=%2250%%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-family=%22Arial%22 font-size=%2216%22 fill=%22%23666%22>Thumbnail not available</text></svg>'">
                    <div class="video-info">
                        <h3>${video.title}</h3>
                        <p class="channel">${video.channel_title}</p>
                        <p class="views">${video.view_count} ‚Ä¢ ${video.published_at}</p>
                    </div>
                `;
                
                videoElement.addEventListener('click', () => selectVideo(video));
                resultsContainer.appendChild(videoElement);
            });

            console.log(`Displayed ${videos.length} search results`);
        }

        // Select video from search results
        function selectVideo(video) {
            // Clear previous selection
            document.querySelectorAll('.video-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Mark current video as selected
            const videoElement = document.querySelector(`[data-video-id="${video.video_id}"]`);
            if (videoElement) {
                videoElement.classList.add('selected');
            }
            
            selectedVideoId = video.video_id;
            console.log('Selected video:', video.title, 'ID:', video.video_id);
        }

        // Modified processVideo function to handle both paste and search modes
        function processVideo() {
            let youtubeUrl = '';
            
            // Check which tab is active
            const activeTab = document.querySelector('.tab-content.active');
            
            if (activeTab.id === 'paste-tab') {
                // Paste mode - get URL from input
                youtubeUrl = document.getElementById('youtube-url').value.trim();
                if (!youtubeUrl) {
                    alert('Please paste a YouTube URL');
                    return;
                }
            } else if (activeTab.id === 'search-tab') {
                // Search mode - use selected video
                if (!selectedVideoId) {
                    alert('Please select a video from the search results');
                    return;
                }
                youtubeUrl = `https://www.youtube.com/watch?v=${selectedVideoId}`;
            }

            // Continue with existing process logic
            processVideoWithUrl(youtubeUrl);
        }

        // Separate the actual processing logic
        function processVideoWithUrl(youtubeUrl) {
            const language = document.getElementById('language-select').value;
            const processBtn = document.getElementById('process-btn');

            fetch(`${API_BASE}/api/v1/generate`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    youtube_url: youtubeUrl,
                    language: language
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                currentJobId = data.job_id;
                currentSessionId = data.session_id;
                
                // Reset log counter for new job
                window.lastLogCount = 0;
                console.log('%c[START] New job started! Detailed logs shown below:', 
                    'color: #4CAF50; font-size: 16px; font-weight: bold;');
                
                // Clear any existing status messages and intervals
                if (statusInterval) {
                    clearInterval(statusInterval);
                    statusInterval = null;
                }
                
                // Reset steps display
                resetSteps();
                
                // Update UI - keep original button text
                processBtn.disabled = true;
                
                // Start directly with STEP 1/5 - no gray "Processing..." state
                globalProgress = 0;
                targetProgress = 20; // Start with 20% for first step
                currentStep = 0;
                window.lastStatus = null;
                // DON'T show any status box initially - let updateStepsBasedOnStatus handle it
                
                // Then update with backend status which will start the animation
                updateStepsBasedOnStatus('PROCESSING');
                
                // Start polling for status
                statusInterval = setInterval(async () => {
                    try {
                        const statusResponse = await fetch(`${API_BASE}/api/v1/status/${currentJobId}`);
                        if (!statusResponse.ok) {
                            throw new Error(`Status check failed: ${statusResponse.status}`);
                        }
                        
                        const statusData = await statusResponse.json();
                        updateStepsBasedOnStatus(statusData.status);
                        
                        // Display logs in browser console
                        if (statusData.logs && statusData.logs.length > 0) {
                            // Only show new logs since last check
                            const lastLogCount = window.lastLogCount || 0;
                            const newLogs = statusData.logs.slice(lastLogCount);
                            
                            newLogs.forEach(log => {
                                console.log(`%c[${log.timestamp}] ${log.message}`, 
                                    'color: #2196F3; font-weight: bold;');
                            });
                            
                            window.lastLogCount = statusData.logs.length;
                        }
                        
                        if (statusData.status.toUpperCase() === 'COMPLETED') {
                            clearInterval(statusInterval);
                            statusInterval = null;
                            
                            // Create download URL
                            const downloadUrl = `${API_BASE}/api/v1/result/${currentJobId}`;
                            
                            // Show completion status with 100% progress
                            showMainStatusBox('COMPLETED: PDF generated successfully!', 100);
                            
                            // Create and add download button after status box
                            setTimeout(() => {
                                const statusBox = document.getElementById('main-status-box');
                                const statusText = document.getElementById('main-status-text');
                                
                                // Clear the progress fill for clean look
                                const fill = document.getElementById('main-status-progress-fill');
                                fill.style.width = '100%';
                                fill.style.background = 'rgba(76,175,80,0.3)';
                                
                                statusText.innerHTML = `
                                    PDF generated successfully! 
                                    <br><br>
                                    <button onclick="downloadPDF('${downloadUrl}')" class="btn download-btn" style="display:inline-block;margin-top:1rem;padding:0.8rem 1.5rem;background:#4caf50;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                                    ${getHeroIcon('download')} Download Recipe (PDF)
                                </button>
                            `;
                            }, 500);
                            
                            // Reset process button
                            processBtn.disabled = false;
                            processBtn.innerHTML = `${getHeroIcon('rocket')} Create PDF Instructions`;
                            
                            // Final completion message in console
                            console.log('%c[COMPLETE] JOB COMPLETED! PDF download available.', 
                                'color: #4CAF50; font-size: 16px; font-weight: bold;');
                            
                            // Save job ID for future downloads
                            localStorage.setItem('makeiteasy_last_job_id', currentJobId);
                            
                        } else if (statusData.status.toUpperCase() === 'FAILED') {
                            clearInterval(statusInterval);
                            statusInterval = null;
                            showMainStatusBox(`Error: ${statusData.error || 'Unknown error'}`, 0);
                            processBtn.disabled = false;
                            processBtn.innerHTML = `${getHeroIcon('rocket')} Create PDF Instructions`;
                            
                            // Error message in console
                            console.error(`%c[ERROR] JOB FAILED: ${statusData.error || 'Unknown error'}`, 
                                'color: #F44336; font-size: 16px; font-weight: bold;');
                            
                            // Reset job tracking and global state
                            currentJobId = null;
                            currentSessionId = null;
                        }
                    } catch (error) {
                        console.error('Error checking status:', error);
                        clearInterval(statusInterval);
                        statusInterval = null;
                        showMainStatusBox(`Error checking status`, 0);
                        processBtn.disabled = false;
                        processBtn.innerHTML = `${getHeroIcon('rocket')} Create PDF Instructions`;
                        
                        // Reset job tracking and global state
                        currentJobId = null;
                        currentSessionId = null;
                    }
                }, 1000);
            })
            .catch(error => {
                console.error('Error:', error);
                showMainStatusBox(`Error processing video`, 0);
                processBtn.disabled = false;
                processBtn.innerHTML = `${getHeroIcon('rocket')} Create PDF Instructions`;
            });
        }



        // Allow Enter key to submit
        document.getElementById('youtube-url').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                processVideo();
            }
        });

        // Function to download PDF when button is clicked
        function downloadPDF(downloadUrl) {
            console.log('[DOWNLOAD] Attempting PDF download from:', downloadUrl);
            
            // Update button to show download starting
            const downloadBtn = document.querySelector('.download-btn');
            if (downloadBtn) {
                downloadBtn.innerHTML = `${getHeroIcon('spinner', 'heroicon-spin')} Downloading...`;
                downloadBtn.style.background = '#45a049';
                downloadBtn.disabled = true;
            }
            
            // Simple direct download approach
            try {
                // Method 1: Direct link click
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = 'MakeItEasy_Recipe.pdf';
                link.target = '_blank';
                link.style.display = 'none';
                document.body.appendChild(link);
                
                console.log('[DOWNLOAD] Triggering download link click...');
                link.click();
                
                // Clean up
                setTimeout(() => {
                    document.body.removeChild(link);
                }, 1000);
                
                // Update button to show success
                if (downloadBtn) {
                    downloadBtn.innerHTML = `${getHeroIcon('check')} Download Started!`;
                    downloadBtn.style.background = '#4CAF50';
                    
                    // Re-enable after 3 seconds
                    setTimeout(() => {
                        downloadBtn.innerHTML = `${getHeroIcon('download')} Download Recipe (PDF)`;
                        downloadBtn.disabled = false;
                    }, 3000);
                }
                
                console.log('[SUCCESS] PDF download initiated!');
                
            } catch (error) {
                console.error('[ERROR] PDF download failed:', error);
                
                // Fallback: Open in new window
                console.log('[FALLBACK] Opening PDF in new window...');
                window.open(downloadUrl, '_blank');
                
                // Update button to show it opened in new tab
                if (downloadBtn) {
                    downloadBtn.innerHTML = `${getHeroIcon('check')} Opened in New Tab`;
                    downloadBtn.style.background = '#4CAF50';
                    
                    setTimeout(() => {
                        downloadBtn.innerHTML = `${getHeroIcon('download')} Download Recipe (PDF)`;
                        downloadBtn.disabled = false;
                    }, 3000);
                }
            }
        }

        // I JavaScript: Ers√§tt alla statusDiv.className, statusDiv.innerHTML, statusDiv.style.display med motsvarande p√• global-status-message
        // Exempel: visa felmeddelande
        function showMainStatusBox(text, percent) {
            const box = document.getElementById('main-status-box');
            const txt = document.getElementById('main-status-text');
            const fill = document.getElementById('main-status-progress-fill');
            box.style.display = 'block';
            txt.textContent = text;
            fill.style.width = percent + '%';
            
            // Progressive green color - more opaque and greener as progress increases
            const greenIntensity = Math.min(percent / 100, 1);
            const alpha = 0.1 + (greenIntensity * 0.4); // From 0.1 to 0.5 opacity
            const greenValue = 40 + (greenIntensity * 127); // From 40 to 167 (darker to lighter green)
            
            fill.style.background = `rgba(${greenValue},${Math.min(200, 120 + greenIntensity * 80)},69,${alpha})`;
            
            // Keep text dark for readability
            txt.style.color = '#495057';
        }
        function hideMainStatusBox() {
            const box = document.getElementById('main-status-box');
            const txt = document.getElementById('main-status-text');
            const fill = document.getElementById('main-status-progress-fill');
            box.style.display = 'none';
            txt.textContent = '';
            fill.style.width = '0%';
            txt.style.color = '#1a237e';
        }

        // Authentication Variables
        let authToken = localStorage.getItem('authToken');
        let currentUser = null;

        // Modal functions
        function showGuestModal() {
            document.getElementById('guest-modal').style.display = 'block';
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }

        function closeGuestModal() {
            console.log('closeGuestModal function called');
            const modal = document.getElementById('guest-modal');
            if (modal) {
                modal.remove(); // Completely remove from DOM instead of hiding
                console.log('Modal removed from DOM');
            } else {
                console.error('Modal element not found!');
            }
            document.body.style.overflow = 'auto';
            localStorage.setItem('guestModalSeen', 'true'); // Remember user has seen it
        }

        function continueAsGuest() {
            console.log('continueAsGuest function called');
            closeGuestModal();
            // User continues with guest access - modal won't show again
        }

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('guest-modal');
            if (event.target === modal) {
                closeGuestModal();
            }
        }

        // Reset counter function
        async function resetCounter() {
            try {
                const response = await fetch(`${API_BASE}/api/v1/reset`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    // Also reset the modal state so it shows again
                    localStorage.removeItem('guestModalSeen');
                    alert(`Rate limiting reset! IP: ${data.ip}\nThe welcome modal will appear again on next page load.`);
                } else {
                    alert('Failed to reset counter');
                }
            } catch (error) {
                console.error('Reset error:', error);
                alert('Failed to reset counter');
            }
        }

        // Check if user is logged in on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Check for OAuth callback parameters
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');
            
            if (code) {
                // Handle Google OAuth callback with authorization code
                console.log('OAuth code received, exchanging for token...');
                handleGoogleOAuthCallback(code);
            } else if (error) {
                // Handle OAuth error
                const message = urlParams.get('error_description') || 'Authentication failed';
                alert(`OAuth Error: ${message}`);
                // Clean up URL
                window.history.replaceState({}, document.title, window.location.pathname);
                showAuthSection();
            } else {
                checkAuthStatus();
            }
            
            initializeTabs();
            setupAuthForms();
            
            // Google OAuth uses simple redirect approach - no SDK needed
            
            // Add search functionality
            document.getElementById('search-btn').addEventListener('click', searchYouTube);
            document.getElementById('youtube-search').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchYouTube();
                }
            });
            
            // Add modal button event listeners
            function setupModalButtons() {
                const continueBtn = document.getElementById('continue-guest-btn');
                const signupBtn = document.getElementById('signup-btn');
                
                if (continueBtn) {
                    continueBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        console.log('Continue guest button clicked');
                        continueAsGuest();
                    });
                    console.log('Continue guest button event listener added');
                } else {
                    console.error('Continue guest button not found');
                }
                
                if (signupBtn) {
                    signupBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        console.log('Signup button clicked');
                        showAuthSection();
                    });
                    console.log('Signup button event listener added');
                } else {
                    console.error('Signup button not found');
                }
            }
            
            // Try to set up modal buttons immediately
            setupModalButtons();
            
            // Also try again after a short delay in case DOM isn't fully ready
            setTimeout(setupModalButtons, 100);
        });

        async function checkAuthStatus() {
            if (authToken) {
                try {
                    const response = await fetch(`${API_BASE}/api/v1/auth/me`, {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                    
                    if (response.ok) {
                        const user = await response.json();
                        currentUser = user;
                        showAppSection(true); // Show logged in version
                    } else {
                        // Token invalid, clear it
                        localStorage.removeItem('authToken');
                        authToken = null;
                        showAppSection(false); // Show guest version
                    }
                } catch (error) {
                    console.error('Auth check error:', error);
                    showAppSection(false); // Show guest version
                }
            } else {
                showAppSection(false); // Show guest version
            }
        }

        function showAuthSection() {
            console.log('showAuthSection function called');
            closeGuestModal(); // Close modal first
            document.getElementById('auth-section').style.display = 'block';
            document.getElementById('app-section').style.display = 'none';
            
            // Switch to login tab
            document.querySelectorAll('.auth-tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.auth-tab-content').forEach(content => content.classList.remove('active'));
            document.querySelector('[data-tab="login"]').classList.add('active');
            document.getElementById('login-tab').classList.add('active');
        }

        function showCreateAccountForm() {
            console.log('showCreateAccountForm function called');
            closeGuestModal(); // Close modal first
            document.getElementById('auth-section').style.display = 'block';
            document.getElementById('app-section').style.display = 'none';
            
            // Switch to register tab
            document.querySelectorAll('.auth-tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.auth-tab-content').forEach(content => content.classList.remove('active'));
            document.querySelector('[data-tab="register"]').classList.add('active');
            document.getElementById('register-tab').classList.add('active');
        }

        function showAppSection(isLoggedIn = false) {
            console.log('showAppSection called with isLoggedIn:', isLoggedIn);
            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('app-section').style.display = 'block';
            
            const guestControls = document.getElementById('guest-controls');
            const loggedInControls = document.getElementById('logged-in-controls');
            const authPrompt = document.getElementById('auth-prompt');
            
            if (isLoggedIn && currentUser) {
                console.log('Showing logged in version for user:', currentUser.full_name);
                document.getElementById('welcome-message').textContent = `Welcome, ${currentUser.full_name}!`;
                
                // Show logged in controls, hide guest controls
                guestControls.style.display = 'none';
                loggedInControls.style.display = 'flex';
                
                if (authPrompt) authPrompt.style.display = 'none';
            } else {
                console.log('Showing guest version');
                
                // Show guest controls, hide logged in controls
                guestControls.style.display = 'flex';
                loggedInControls.style.display = 'none';
                
                // Show welcome modal for first-time guests
                if (!localStorage.getItem('guestModalSeen')) {
                    showGuestModal();
                }
            }
        }

        function setupAuthForms() {
            // Auth tab switching
            document.querySelectorAll('.auth-tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tab = this.dataset.tab;
                    
                    // Update active tab button
                    document.querySelectorAll('.auth-tab-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Update active tab content
                    document.querySelectorAll('.auth-tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(`${tab}-tab`).classList.add('active');
                });
            });

            // Login form
            document.getElementById('login-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                
                try {
                    const response = await fetch(`${API_BASE}/api/v1/auth/login`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ email, password })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        authToken = data.access_token;
                        currentUser = data.user;
                        localStorage.setItem('authToken', authToken);
                        showAppSection(true);
                    } else {
                        const error = await response.json();
                        alert(error.detail || 'Login failed');
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    alert('Login failed. Please try again.');
                }
            });

            // Register form
            document.getElementById('register-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const full_name = document.getElementById('register-name').value;
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                
                try {
                    const response = await fetch(`${API_BASE}/api/v1/auth/register`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ full_name, email, password })
                    });
                    
                        if (response.ok) {
                        const data = await response.json();
                        authToken = data.access_token;
                        currentUser = data.user;
                        localStorage.setItem('authToken', authToken);
                        showAppSection(true);
                    } else {
                        const error = await response.json();
                        alert(error.detail || 'Registration failed');
                    }
                } catch (error) {
                    console.error('Register error:', error);
                    alert('Registration failed. Please try again.');
                }
            });

            // Logout button
            document.getElementById('logout-btn').addEventListener('click', function() {
                authToken = null;
                currentUser = null;
                localStorage.removeItem('authToken');
                showAppSection(false); // Show guest version instead of auth section
            });

            // Google Sign-In buttons
            document.getElementById('google-signin-btn').addEventListener('click', function() {
                console.log('Google Sign-In button clicked');
                initiateGoogleSignIn();
            });

            document.getElementById('google-signup-btn').addEventListener('click', function() {
                console.log('Google Sign-Up button clicked');
                initiateGoogleSignIn();
            });
        }

        // Google Sign-In functionality
        async function initiateGoogleSignIn() {
            console.log('initiateGoogleSignIn called');
            try {
                // Get Google OAuth config from backend
                console.log('Fetching Google OAuth config...');
                const configResponse = await fetch(`${API_BASE}/api/v1/auth/google/config`);
                if (!configResponse.ok) {
                    throw new Error('Failed to get Google OAuth config');
                }
                
                const config = await configResponse.json();
                console.log('Google OAuth config:', config);
                
                if (!config.enabled || !config.client_id) {
                    alert('Google Sign-In is not configured. Please use email/password authentication.');
                    return;
                }

                // Use simple redirect approach instead of JavaScript SDK
                console.log('Redirecting to Google OAuth...');
                
                const params = new URLSearchParams({
                    client_id: config.client_id,
                    redirect_uri: window.location.origin,
                    response_type: 'code',
                    scope: 'email profile',
                    access_type: 'offline',
                    prompt: 'select_account'
                });
                
                const googleAuthUrl = `https://accounts.google.com/o/oauth2/v2/auth?${params.toString()}`;
                console.log('Redirecting to:', googleAuthUrl);
                
                // Redirect to Google OAuth
                window.location.href = googleAuthUrl;
                
            } catch (error) {
                console.error('Google Sign-In initialization error:', error);
                alert('Google Sign-In is not available. Please use email/password authentication.');
            }
        }

        async function handleGoogleOAuthCallback(code) {
            try {
                console.log('Sending authorization code to backend...');
                
                // Send the authorization code to our backend
                const authResponse = await fetch(`${API_BASE}/api/v1/auth/google/callback`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        code: code
                    })
                });

                if (authResponse.ok) {
                    const data = await authResponse.json();
                    authToken = data.access_token;
                    currentUser = data.user;
                    localStorage.setItem('authToken', authToken);
                    
                    // Clean up URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                    
                    // Show app section
                    showAppSection(true);
                    
                    console.log('Google OAuth successful, user logged in:', currentUser.email);
                } else {
                    const error = await authResponse.json();
                    console.error('Google OAuth callback error:', error);
                    alert(error.detail || 'Google Sign-In failed');
                    
                    // Clean up URL and show auth section
                    window.history.replaceState({}, document.title, window.location.pathname);
                    showAuthSection();
                }
            } catch (error) {
                console.error('Google OAuth callback error:', error);
                alert('Google Sign-In failed. Please try again.');
                
                // Clean up URL and show auth section
                window.history.replaceState({}, document.title, window.location.pathname);
                showAuthSection();
            }
        }

        async function handleGoogleSignIn(response) {
            try {
                // Send the ID token to our backend
                const authResponse = await fetch(`${API_BASE}/api/v1/auth/google/mobile`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        id_token: response.credential
                    })
                });

                if (authResponse.ok) {
                    const data = await authResponse.json();
                    authToken = data.access_token;
                    currentUser = data.user;
                    localStorage.setItem('authToken', authToken);
                    showAppSection(true);
                } else {
                    const error = await authResponse.json();
                    alert(error.detail || 'Google Sign-In failed');
                }
            } catch (error) {
                console.error('Google Sign-In error:', error);
                alert('Google Sign-In failed. Please try again.');
            }
        }

        // Update processVideoWithUrl to work with optional auth
        function processVideoWithUrl(youtubeUrl) {

            const language = document.getElementById('language-select').value;
            const processBtn = document.getElementById('process-btn');

            const headers = {
                'Content-Type': 'application/json'
            };
            
            // Add auth header only if user is logged in
            if (authToken) {
                headers['Authorization'] = `Bearer ${authToken}`;
            }

            fetch(`${API_BASE}/api/v1/generate`, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({
                    youtube_url: youtubeUrl,
                    language: language
                })
            })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 401) {
                        alert('Your session has expired. Please sign in again.');
                        authToken = null;
                        localStorage.removeItem('authToken');
                        showAuthSection();
                        return;
                    }
                    if (response.status === 429) {
                        return response.json().then(error => {
                            alert(error.detail || 'Too many requests. Create a free account for unlimited usage.');
                            throw new Error('Rate limited');
                        });
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                currentJobId = data.job_id;
                currentSessionId = data.session_id;
                
                // Reset log counter for new job
                window.lastLogCount = 0;
                console.log('%c[START] New job started! Detailed logs shown below:', 
                    'color: #4CAF50; font-size: 16px; font-weight: bold;');
                
                // Clear any existing status messages and intervals
                if (statusInterval) {
                    clearInterval(statusInterval);
                    statusInterval = null;
                }
                
                // Reset steps display
                resetSteps();
                
                // Update UI - keep original button text
                    processBtn.disabled = true;
                
                // Start directly with STEP 1/5 - no gray "Processing..." state
                globalProgress = 0;
                targetProgress = 20; // Start with 20% for first step
                currentStep = 0;
                window.lastStatus = null;
                // DON'T show any status box initially - let updateStepsBasedOnStatus handle it
                
                // Then update with backend status which will start the animation
                updateStepsBasedOnStatus('PROCESSING');
                
                // Start polling for status
                statusInterval = setInterval(async () => {
                    try {
                        const statusHeaders = {};
                        if (authToken) {
                            statusHeaders['Authorization'] = `Bearer ${authToken}`;
                        }
                        
                        const statusResponse = await fetch(`${API_BASE}/api/v1/status/${currentJobId}`, {
                            headers: statusHeaders
                        });
                        if (!statusResponse.ok) {
                            throw new Error(`Status check failed: ${statusResponse.status}`);
                        }
                        
                        const statusData = await statusResponse.json();
                        updateStepsBasedOnStatus(statusData.status);
                        
                        // Display logs in browser console
                        if (statusData.logs && statusData.logs.length > 0) {
                            // Only show new logs since last check
                            const lastLogCount = window.lastLogCount || 0;
                            const newLogs = statusData.logs.slice(lastLogCount);
                            
                            newLogs.forEach(log => {
                                console.log(`%c[${log.timestamp}] ${log.message}`, 
                                    'color: #2196F3; font-weight: bold;');
                            });
                            
                            window.lastLogCount = statusData.logs.length;
                        }
                        
                        if (statusData.status.toUpperCase() === 'COMPLETED') {
                            clearInterval(statusInterval);
                            statusInterval = null;
                            
                            // Create download URL with auth token
                            const downloadUrl = `${API_BASE}/api/v1/result/${currentJobId}`;
                            
                            // Show completion status with 100% progress
                            showMainStatusBox('COMPLETED: PDF generated successfully!', 100);
                            
                            // Create and add download button after status box
                            setTimeout(() => {
                                const statusBox = document.getElementById('main-status-box');
                                const statusText = document.getElementById('main-status-text');
                                
                                // Clear the progress fill for clean look
                                const fill = document.getElementById('main-status-progress-fill');
                                fill.style.width = '100%';
                                fill.style.background = 'rgba(76,175,80,0.3)';
                                
                                statusText.innerHTML = `
                                    PDF generated successfully! 
                                    <br><br>
                                    <button onclick="downloadPDF('${downloadUrl}')" class="btn download-btn" style="display:inline-block;margin-top:1rem;padding:0.8rem 1.5rem;background:#4caf50;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                                        ${getHeroIcon('download')} Download Recipe (PDF)
                                    </button>
                                `;
                            }, 500);
                            
                            // Reset process button
                    processBtn.disabled = false;
                    processBtn.innerHTML = `${getHeroIcon('rocket')} Create PDF Instructions`;
                }
                        
                    } catch (error) {
                        console.error('Error checking status:', error);
                        clearInterval(statusInterval);
                        statusInterval = null;
                        showMainStatusBox(`Error checking status`, 0);
                        processBtn.disabled = false;
                        processBtn.innerHTML = `${getHeroIcon('rocket')} Create PDF Instructions`;
                    }
                }, 1000);
            })
            .catch(error => {
                console.error('Error:', error);
                showMainStatusBox(`Error processing video`, 0);
                processBtn.disabled = false;
                processBtn.innerHTML = `${getHeroIcon('rocket')} Create PDF Instructions`;
            });
        }

        // Update downloadPDF to work with optional auth
        function downloadPDF(downloadUrl) {
            console.log('[DOWNLOAD] Attempting PDF download from:', downloadUrl);
            
            // Update button to show download starting
            const downloadBtn = document.querySelector('.download-btn');
            if (downloadBtn) {
                downloadBtn.innerHTML = `${getHeroIcon('spinner', 'heroicon-spin')} Downloading...`;
                downloadBtn.style.background = '#45a049';
                downloadBtn.disabled = true;
            }
            
            // Download with optional auth header
            const downloadHeaders = {};
            if (authToken) {
                downloadHeaders['Authorization'] = `Bearer ${authToken}`;
            }
            
            fetch(downloadUrl, {
                headers: downloadHeaders
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Download failed');
                }
                return response.blob();
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'MakeItEasy_Recipe.pdf';
                link.click();
                window.URL.revokeObjectURL(url);
                
                // Update button to show success
                if (downloadBtn) {
                    downloadBtn.innerHTML = `${getHeroIcon('check')} Download Started!`;
                    downloadBtn.style.background = '#4CAF50';
                    
                setTimeout(() => {
                    downloadBtn.innerHTML = `${getHeroIcon('download')} Download Recipe (PDF)`;
                    downloadBtn.disabled = false;
                }, 3000);
            }
            })
            .catch(error => {
                console.error('[ERROR] PDF download failed:', error);
                alert('Download failed');
                
                if (downloadBtn) {
                    downloadBtn.innerHTML = `${getHeroIcon('download')} Download Recipe (PDF)`;
                    downloadBtn.disabled = false;
                }
            });
        }
    </script>
</body>
</html> 