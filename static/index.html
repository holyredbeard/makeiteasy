<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Make It Easy - YouTube to PDF</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="static/images/logo.png" alt="Make It Easy logo">
            <p>Transform YouTube how-to videos into step-by-step PDF instructions</p>
        </div>
        
        <div class="card">
            <!-- Tabs -->
            <div class="tabs">
                <div class="tab-buttons">
                    <button class="tab-btn active" data-tab="paste">📎 Paste Link</button>
                    <button class="tab-btn" data-tab="search">🔍 Search YouTube</button>
                </div>
            </div>

            <!-- Paste Tab Content -->
            <div id="paste-tab" class="tab-content active">
                <div class="input-group">
                    <label for="youtube-url">YouTube URL:</label>
                    <input 
                        type="url" 
                        id="youtube-url" 
                        placeholder="Paste YouTube link here... (e.g. https://www.youtube.com/watch?v=...)"
                        required
                    >
                </div>
            </div>

            <!-- Search Tab Content -->
            <div id="search-tab" class="tab-content">
                <div class="search-section">
                    <label for="youtube-search">YouTube search:</label>
                    <div class="search-input-group">
                        <input 
                            type="text" 
                            id="youtube-search" 
                            placeholder="recipe"
                            value="recipe"
                        >
                        <button id="search-btn" class="btn search-btn">Search</button>
                    </div>
                </div>

                <div id="search-results" class="search-results">
                    <div class="search-placeholder">
                        <p>
                            🔍 Search for cooking videos above to see results here
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="input-group">
                <label for="language-select">Language:</label>
                <select id="language-select" class="language-select">
                    <option value="en" selected>🇺🇸 English</option>
                    <option value="sv">🇸🇪 Svenska</option>
                    <option value="no">🇳🇴 Norsk</option>
                    <option value="da">🇩🇰 Dansk</option>
                    <option value="de">🇩🇪 Deutsch</option>
                    <option value="fr">🇫🇷 Français</option>
                    <option value="es">🇪🇸 Español</option>
                    <option value="it">🇮🇹 Italiano</option>
                    <option value="pt">🇵🇹 Português</option>
                    <option value="nl">🇳🇱 Nederlands</option>
                    <option value="pl">🇵🇱 Polski</option>
                    <option value="ru">🇷🇺 Русский</option>
                    <option value="zh">🇨🇳 中文</option>
                    <option value="ja">🇯🇵 日本語</option>
                    <option value="ko">🇰🇷 한국어</option>
                </select>
            </div>
            <button id="process-btn" class="btn" onclick="processVideo()">
                <svg class="heroicon" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.59 14.37a6 6 0 0 1-5.84 7.38v-4.8m5.84-2.58a14.98 14.98 0 0 0 6.16-12.12A14.98 14.98 0 0 0 9.631 8.41m5.96 5.96a14.926 14.926 0 0 1-5.841 2.58m-.119-8.54a6 6 0 0 0-7.381 5.84h4.8m2.581-5.84a14.927 14.927 0 0 0-2.58 5.84m2.58-5.84a14.917 14.917 0 0 1 5.84 2.58" />
                </svg>
                Create PDF Instructions
            </button>
            <!-- Main progress status bar -->
            <div id="main-status-box">
                <span id="main-status-text">Status</span>
                <div id="main-status-progress-fill"></div>
            </div>
        </div>
        
        <div class="footer">
            <p>Powered by Deepseek AI, BLIP-2 OPT 2.7B & FFmpeg</p>
        </div>
    </div>

    <script>
        let currentJobId = null;
        let currentSessionId = null;
        let statusInterval = null;
        let isGloballyProcessing = false;
        let selectedVideoId = null;
        
        const API_BASE = 'http://localhost:8000';
        
        // Heroicons helper function
        function getHeroIcon(iconName, extraClasses = '') {
            const icons = {
                'rocket': `<svg class="heroicon ${extraClasses}" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.59 14.37a6 6 0 0 1-5.84 7.38v-4.8m5.84-2.58a14.98 14.98 0 0 0 6.16-12.12A14.98 14.98 0 0 0 9.631 8.41m5.96 5.96a14.926 14.926 0 0 1-5.841 2.58m-.119-8.54a6 6 0 0 0-7.381 5.84h4.8m2.581-5.84a14.927 14.927 0 0 0-2.58 5.84m2.58-5.84a14.917 14.917 0 0 1 5.84 2.58" />
                </svg>`,
                'spinner': `<svg class="heroicon heroicon-spin ${extraClasses}" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
                </svg>`,
                'check-circle': `<svg class="heroicon ${extraClasses}" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                </svg>`,
                'exclamation-triangle': `<svg class="heroicon ${extraClasses}" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
                </svg>`,
                'download': `<svg class="heroicon ${extraClasses}" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
                </svg>`,
                'info-circle': `<svg class="heroicon ${extraClasses}" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="m11.25 11.25.041-.02a.75.75 0 0 1 1.063.852l-.708 2.836a.75.75 0 0 0 1.063.853l.041-.021M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9-3.75h.008v.008H12V8.25Z" />
                </svg>`,
                'clock': `<svg class="heroicon ${extraClasses}" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                </svg>`,
                'check': `<svg class="heroicon ${extraClasses}" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" />
                </svg>`,
                'magnifying-glass': `<svg class="heroicon ${extraClasses}" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
                </svg>`,
                'photo': `<svg class="heroicon ${extraClasses}" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm10.5-11.25h.008v.008h-.008V8.25Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" />
                </svg>`
            };
            return icons[iconName] || '';
        }

        // --- SINGLE PROGRESS BAR LOGIK ---
        
        const stepLabels = [
            'Downloading video from YouTube',
            'Transcribing audio content', 
            'Analyzing content with AI',
            'Extracting key frames',
            'Generating PDF instructions'
        ];
        
        // Calculate overall progress based on step
        function getProgressForStep(stepIndex, stepProgress = 50) {
            const stepWeights = [20, 30, 20, 15, 15]; // Each step's percentage of total
            let totalProgress = 0;
            
            // Add completed steps
            for (let i = 0; i < stepIndex; i++) {
                totalProgress += stepWeights[i];
            }
            
            // Add current step progress
            if (stepIndex < stepWeights.length) {
                totalProgress += (stepWeights[stepIndex] * stepProgress / 100);
            }
            
            return Math.min(Math.round(totalProgress), 100);
        }
        
        function updateMainProgress(stepIndex, stepProgress = 50) {
            const totalProgress = getProgressForStep(stepIndex, stepProgress);
            const stepNum = stepIndex + 1;
            const message = `STEP ${stepNum}/5: ${stepLabels[stepIndex]}`;
            showMainStatusBox(message, totalProgress);
        }
        // Global progress tracking
        let globalProgress = 0;
        let targetProgress = 0;
        let currentStep = 0;
        
        // Update progress based on backend status
        function updateStepsBasedOnStatus(status) {
            const statusUpper = status.toUpperCase();
            
            // Don't restart if we're already processing this status
            if (statusUpper === window.lastStatus) return;
            window.lastStatus = statusUpper;
            
            // Set target progress based on status
            switch(statusUpper) {
                case 'PROCESSING':
                    currentStep = 0;
                    targetProgress = 20; // Download step target
                    // Show immediately to avoid any gray state
                    showMainStatusBox('STEP 1/5: Downloading video from YouTube', 5);
                    break;
                case 'TRANSCRIBING':
                    currentStep = 1;
                    targetProgress = 50; // Transcribe step target (20+30)
                    break;
                case 'ANALYZING':
                    currentStep = 2;
                    targetProgress = 70; // Analyze step target (50+20)
                    break;
                case 'EXTRACTING_FRAMES':
                    currentStep = 3;
                    targetProgress = 85; // Extract step target (70+15)
                    break;
                case 'GENERATING_PDF':
                    currentStep = 4;
                    targetProgress = 100; // Final step target
                    break;
                case 'COMPLETED':
                    stopContinuousProgress();
                    showMainStatusBox('COMPLETED: PDF generated successfully!', 100);
                    return;
                case 'FAILED':
                    stopContinuousProgress();
                    showMainStatusBox('FAILED: Processing failed', 0);
                    return;
            }
            
            // Start continuous progress if not already running
            if (!window.progressInterval) {
                startContinuousProgress();
            }
        }
        
        // Continuous smooth progress animation
        function startContinuousProgress() {
            // If no interval is running, start one
            if (window.progressInterval) return;
            
            window.progressInterval = setInterval(() => {
                // Move towards target progress smoothly
                if (globalProgress < targetProgress) {
                    const diff = targetProgress - globalProgress;
                    const increment = Math.max(0.1, diff * 0.02); // Slower approach as we get closer
                    globalProgress = Math.min(globalProgress + increment, targetProgress);
                } else if (globalProgress < 100 && targetProgress < 100) {
                    // Add slight movement even when waiting for next status
                    globalProgress = Math.min(globalProgress + 0.05, targetProgress + 5);
                }
                
                // Update the UI
                const stepNum = currentStep + 1;
                const message = `STEP ${stepNum}/5: ${stepLabels[currentStep]}`;
                showMainStatusBox(message, Math.round(globalProgress));
                
                // Stop if we've reached 100%
                if (globalProgress >= 100) {
                    stopContinuousProgress();
                }
            }, 50); // Update every 50ms for smooth animation
        }
        
        function stopContinuousProgress() {
            if (window.progressInterval) {
                clearInterval(window.progressInterval);
                window.progressInterval = null;
            }
        }

        // Reset progress bar
        function resetSteps() {
            stopContinuousProgress();
            globalProgress = 0;
            targetProgress = 0;
            currentStep = 0;
            hideMainStatusBox();
            window.lastStatus = null;
            console.log('Progress reset');
        }
        
        // Tab functionality
        function initializeTabs() {
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTab = button.getAttribute('data-tab');
                    
                    // Remove active class from all buttons and content
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // Add active class to clicked button and corresponding content
                    button.classList.add('active');
                    document.getElementById(targetTab + '-tab').classList.add('active');
                });
            });
        }

        // YouTube search functionality
        async function searchYouTube() {
            const query = document.getElementById('youtube-search').value.trim();
            if (!query) return;

            const searchBtn = document.getElementById('search-btn');
            const originalText = searchBtn.innerHTML;
            
            searchBtn.disabled = true;
            searchBtn.innerHTML = `${getHeroIcon('spinner')} Searching...`;

            try {
                console.log('Searching for:', query);
                const response = await fetch(`${API_BASE}/api/v1/search`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: query,
                        language: document.getElementById('language-select').value
                    })
                });

                if (!response.ok) {
                    throw new Error(`Search failed: ${response.status}`);
                }

                const data = await response.json();
                console.log('Search response:', data);
                
                if (data.videos) {
                    displaySearchResults(data.videos);
                } else {
                    console.error('No videos field in response:', data);
                    displaySearchResults([]);
                }
            } catch (error) {
                console.error('Search error:', error);
                
                // Show error message
                const resultsContainer = document.getElementById('search-results');
                resultsContainer.innerHTML = `
                    <div class="search-placeholder">
                        <p style="text-align: center; color: #e74c3c; padding: 2rem;">
                            ❌ Search failed: ${error.message}
                        </p>
                    </div>
                `;
            } finally {
                searchBtn.disabled = false;
                searchBtn.innerHTML = originalText;
            }
        }

        // Display search results
        function displaySearchResults(videos) {
            const resultsContainer = document.getElementById('search-results');
            resultsContainer.innerHTML = '';

            if (!videos || videos.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="search-placeholder">
                        <p style="text-align: center; color: #666; padding: 2rem;">
                            No videos found for your search. Try different keywords.
                        </p>
                    </div>
                `;
                return;
            }

            videos.forEach(video => {
                const videoElement = document.createElement('div');
                videoElement.className = 'video-item';
                videoElement.setAttribute('data-video-id', video.video_id);
                
                videoElement.innerHTML = `
                    <img src="https://i.ytimg.com/vi/${video.video_id}/mqdefault.jpg" alt="Video thumbnail" class="video-thumbnail" 
                         onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22320%22 height=%22180%22><rect width=%22100%%22 height=%22100%%22 fill=%22%23f0f0f0%22/><text x=%2250%%22 y=%2250%%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-family=%22Arial%22 font-size=%2216%22 fill=%22%23666%22>Thumbnail not available</text></svg>'">
                    <div class="video-info">
                        <h3>${video.title}</h3>
                        <p class="channel">${video.channel_title}</p>
                        <p class="views">${video.view_count} • ${video.published_at}</p>
                    </div>
                `;
                
                videoElement.addEventListener('click', () => selectVideo(video));
                resultsContainer.appendChild(videoElement);
            });

            console.log(`Displayed ${videos.length} search results`);
        }

        // Select video from search results
        function selectVideo(video) {
            // Clear previous selection
            document.querySelectorAll('.video-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Mark current video as selected
            const videoElement = document.querySelector(`[data-video-id="${video.video_id}"]`);
            if (videoElement) {
                videoElement.classList.add('selected');
            }
            
            selectedVideoId = video.video_id;
            console.log('Selected video:', video.title, 'ID:', video.video_id);
        }

        // Modified processVideo function to handle both paste and search modes
        function processVideo() {
            let youtubeUrl = '';
            
            // Check which tab is active
            const activeTab = document.querySelector('.tab-content.active');
            
            if (activeTab.id === 'paste-tab') {
                // Paste mode - get URL from input
                youtubeUrl = document.getElementById('youtube-url').value.trim();
                if (!youtubeUrl) {
                    alert('Please paste a YouTube URL');
                    return;
                }
            } else if (activeTab.id === 'search-tab') {
                // Search mode - use selected video
                if (!selectedVideoId) {
                    alert('Please select a video from the search results');
                    return;
                }
                youtubeUrl = `https://www.youtube.com/watch?v=${selectedVideoId}`;
            }

            // Continue with existing process logic
            processVideoWithUrl(youtubeUrl);
        }

        // Separate the actual processing logic
        function processVideoWithUrl(youtubeUrl) {
            const language = document.getElementById('language-select').value;
            const processBtn = document.getElementById('process-btn');

            fetch(`${API_BASE}/api/v1/generate`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    youtube_url: youtubeUrl,
                    language: language
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                currentJobId = data.job_id;
                currentSessionId = data.session_id;
                
                // Reset log counter for new job
                window.lastLogCount = 0;
                console.log('%c[START] New job started! Detailed logs shown below:', 
                    'color: #4CAF50; font-size: 16px; font-weight: bold;');
                
                // Clear any existing status messages and intervals
                if (statusInterval) {
                    clearInterval(statusInterval);
                    statusInterval = null;
                }
                
                // Reset steps display
                resetSteps();
                
                // Update UI - keep original button text
                processBtn.disabled = true;
                
                // Start directly with STEP 1/5 - no gray "Processing..." state
                globalProgress = 0;
                targetProgress = 20; // Start with 20% for first step
                currentStep = 0;
                window.lastStatus = null;
                // DON'T show any status box initially - let updateStepsBasedOnStatus handle it
                
                // Then update with backend status which will start the animation
                updateStepsBasedOnStatus('PROCESSING');
                
                // Start polling for status
                statusInterval = setInterval(async () => {
                    try {
                        const statusResponse = await fetch(`${API_BASE}/api/v1/status/${currentJobId}`);
                        if (!statusResponse.ok) {
                            throw new Error(`Status check failed: ${statusResponse.status}`);
                        }
                        
                        const statusData = await statusResponse.json();
                        updateStepsBasedOnStatus(statusData.status);
                        
                        // Display logs in browser console
                        if (statusData.logs && statusData.logs.length > 0) {
                            // Only show new logs since last check
                            const lastLogCount = window.lastLogCount || 0;
                            const newLogs = statusData.logs.slice(lastLogCount);
                            
                            newLogs.forEach(log => {
                                console.log(`%c[${log.timestamp}] ${log.message}`, 
                                    'color: #2196F3; font-weight: bold;');
                            });
                            
                            window.lastLogCount = statusData.logs.length;
                        }
                        
                        if (statusData.status.toUpperCase() === 'COMPLETED') {
                            clearInterval(statusInterval);
                            statusInterval = null;
                            
                            // Create download URL
                            const downloadUrl = `${API_BASE}/api/v1/result/${currentJobId}`;
                            
                            // Show completion status with 100% progress
                            showMainStatusBox('COMPLETED: PDF generated successfully!', 100);
                            
                            // Create and add download button after status box
                            setTimeout(() => {
                                const statusBox = document.getElementById('main-status-box');
                                const statusText = document.getElementById('main-status-text');
                                
                                // Clear the progress fill for clean look
                                const fill = document.getElementById('main-status-progress-fill');
                                fill.style.width = '100%';
                                fill.style.background = 'rgba(76,175,80,0.3)';
                                
                                statusText.innerHTML = `
                                    PDF generated successfully! 
                                    <br><br>
                                    <button onclick="downloadPDF('${downloadUrl}')" class="btn download-btn" style="display:inline-block;margin-top:1rem;padding:0.8rem 1.5rem;background:#4caf50;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                                        ${getHeroIcon('download')} Download Recipe (PDF)
                                    </button>
                                `;
                            }, 500);
                            
                            // Reset process button
                            processBtn.disabled = false;
                            processBtn.innerHTML = `${getHeroIcon('rocket')} Create PDF Instructions`;
                            
                            // Final completion message in console
                            console.log('%c[COMPLETE] JOB COMPLETED! PDF download available.', 
                                'color: #4CAF50; font-size: 16px; font-weight: bold;');
                            
                            // Save job ID for future downloads
                            localStorage.setItem('makeiteasy_last_job_id', currentJobId);
                            
                        } else if (statusData.status.toUpperCase() === 'FAILED') {
                            clearInterval(statusInterval);
                            statusInterval = null;
                            showMainStatusBox(`Error: ${statusData.error || 'Unknown error'}`, 0);
                            processBtn.disabled = false;
                            processBtn.innerHTML = `${getHeroIcon('rocket')} Create PDF Instructions`;
                            
                            // Error message in console
                            console.error(`%c[ERROR] JOB FAILED: ${statusData.error || 'Unknown error'}`, 
                                'color: #F44336; font-size: 16px; font-weight: bold;');
                            
                            // Reset job tracking and global state
                            currentJobId = null;
                            currentSessionId = null;
                        }
                    } catch (error) {
                        console.error('Error checking status:', error);
                        clearInterval(statusInterval);
                        statusInterval = null;
                        showMainStatusBox(`Error checking status`, 0);
                        processBtn.disabled = false;
                        processBtn.innerHTML = `${getHeroIcon('rocket')} Create PDF Instructions`;
                        
                        // Reset job tracking and global state
                        currentJobId = null;
                        currentSessionId = null;
                    }
                }, 1000);
            })
            .catch(error => {
                console.error('Error:', error);
                showMainStatusBox(`Error processing video`, 0);
                processBtn.disabled = false;
                processBtn.innerHTML = `${getHeroIcon('rocket')} Create PDF Instructions`;
            });
        }

        // Initialize tabs when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeTabs();
            
            // Add search functionality
            document.getElementById('search-btn').addEventListener('click', searchYouTube);
            document.getElementById('youtube-search').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchYouTube();
                }
            });
        });

        // Allow Enter key to submit
        document.getElementById('youtube-url').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                processVideo();
            }
        });

        // Function to download PDF when button is clicked
        function downloadPDF(downloadUrl) {
            console.log('[DOWNLOAD] Attempting PDF download from:', downloadUrl);
            
            // Update button to show download starting
            const downloadBtn = document.querySelector('.download-btn');
            if (downloadBtn) {
                downloadBtn.innerHTML = `${getHeroIcon('spinner', 'heroicon-spin')} Downloading...`;
                downloadBtn.style.background = '#45a049';
                downloadBtn.disabled = true;
            }
            
            // Simple direct download approach
            try {
                // Method 1: Direct link click
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = 'MakeItEasy_Recipe.pdf';
                link.target = '_blank';
                link.style.display = 'none';
                document.body.appendChild(link);
                
                console.log('[DOWNLOAD] Triggering download link click...');
                link.click();
                
                // Clean up
                setTimeout(() => {
                    document.body.removeChild(link);
                }, 1000);
                
                // Update button to show success
                if (downloadBtn) {
                    downloadBtn.innerHTML = `${getHeroIcon('check')} Download Started!`;
                    downloadBtn.style.background = '#4CAF50';
                    
                    // Re-enable after 3 seconds
                    setTimeout(() => {
                        downloadBtn.innerHTML = `${getHeroIcon('download')} Download Recipe (PDF)`;
                        downloadBtn.disabled = false;
                    }, 3000);
                }
                
                console.log('[SUCCESS] PDF download initiated!');
                
            } catch (error) {
                console.error('[ERROR] PDF download failed:', error);
                
                // Fallback: Open in new window
                console.log('[FALLBACK] Opening PDF in new window...');
                window.open(downloadUrl, '_blank');
                
                // Update button to show it opened in new tab
                if (downloadBtn) {
                    downloadBtn.innerHTML = `${getHeroIcon('check')} Opened in New Tab`;
                    downloadBtn.style.background = '#4CAF50';
                    
                    setTimeout(() => {
                        downloadBtn.innerHTML = `${getHeroIcon('download')} Download Recipe (PDF)`;
                        downloadBtn.disabled = false;
                    }, 3000);
                }
            }
        }

        // I JavaScript: Ersätt alla statusDiv.className, statusDiv.innerHTML, statusDiv.style.display med motsvarande på global-status-message
        // Exempel: visa felmeddelande
        function showMainStatusBox(text, percent) {
            const box = document.getElementById('main-status-box');
            const txt = document.getElementById('main-status-text');
            const fill = document.getElementById('main-status-progress-fill');
            box.style.display = 'block';
            txt.textContent = text;
            fill.style.width = percent + '%';
            
            // Progressive green color - more opaque and greener as progress increases
            const greenIntensity = Math.min(percent / 100, 1);
            const alpha = 0.1 + (greenIntensity * 0.4); // From 0.1 to 0.5 opacity
            const greenValue = 40 + (greenIntensity * 127); // From 40 to 167 (darker to lighter green)
            
            fill.style.background = `rgba(${greenValue},${Math.min(200, 120 + greenIntensity * 80)},69,${alpha})`;
            
            // Keep text dark for readability
            txt.style.color = '#495057';
        }
        function hideMainStatusBox() {
            const box = document.getElementById('main-status-box');
            const txt = document.getElementById('main-status-text');
            const fill = document.getElementById('main-status-progress-fill');
            box.style.display = 'none';
            txt.textContent = '';
            fill.style.width = '0%';
            txt.style.color = '#1a237e';
        }
    </script>
</body>
</html> 